generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SinapseClient {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  apiBaseUrl  String
  apiKey      String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tickets      Ticket[]
  importStates ImportState[]
  conversationMetrics ConversationMetrics[]

  @@map("sinapse_clients")
}

model ImportState {
  id           String   @id @default(uuid())
  key          String
  lastImportAt DateTime @default(now())
  lastPage     Int?
  clientId     String

  client       SinapseClient @relation(fields: [clientId], references: [id])

  @@unique([clientId, key])
  @@map("import_states")
}

model Ticket {
  id                           String    @id @default(uuid())
  externalUuid                 String
  externalTicketId             Int?
  status                       String?
  contactName                  String?
  contactNumber                String?
  contactExternalId            Int?
  contactId                    BigInt?
  socialConnectionId           Int?
  companyId                    Int?
  createdAtExternal            DateTime?
  updatedAtExternal            DateTime?
  lastImportedMessageCreatedAt DateTime?
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt
  clientId                     String

  client   SinapseClient @relation(fields: [clientId], references: [id])
  contact  Contact?      @relation(fields: [clientId, contactId], references: [clientId, id])
  sessions Session[]
  messages Message[]
  importedTrackings ImportedTracking[]

  @@unique([clientId, externalUuid])
  @@index([clientId, contactId])
  @@index([clientId, updatedAtExternal])
  @@map("tickets")
}

model Contact {
  id                 BigInt
  clientId           String
  companyId          BigInt?
  name               String?
  number             String?
  email              String?
  isGroup            Boolean
  socialConnectionId BigInt?
  profilePicUrl      String?
  createdAtRemote    DateTime?
  updatedAtRemote    DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  tags    ContactTag[]
  tickets Ticket[]

  @@id([clientId, id])
  @@index([clientId, number])
  @@map("contacts")
}

model Tag {
  id        BigInt
  clientId  String
  companyId BigInt?
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contacts ContactTag[]

  @@id([clientId, id])
  @@index([clientId, name])
  @@map("tags")
}

model ContactTag {
  clientId  String
  contactId BigInt
  tagId     BigInt
  createdAt DateTime @default(now())

  contact Contact @relation(fields: [clientId, contactId], references: [clientId, id], onDelete: Cascade)
  tag     Tag     @relation(fields: [clientId, tagId], references: [clientId, id], onDelete: Cascade)

  @@id([clientId, contactId, tagId])
  @@index([clientId, tagId])
  @@map("contact_tags")
}

enum SessionType {
  CLOSED
  OPEN_REAL
  OPEN_WEAK
  UNTRACKED
}

model ImportedTracking {
  id                String    @id @default(uuid())
  ticketId          String
  externalTrackingId Int?
  createdAtExternal DateTime
  startedAtExternal DateTime?
  endedAtExternal   DateTime?
  lastRebuildMessageCreatedAt DateTime?
  processedAt       DateTime?
  processingVersion String?
  processingNotes   String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  ticket   Ticket    @relation(fields: [ticketId], references: [id])
  sessions Session[]

  @@map("imported_trackings")
  @@index([ticketId])
}

model Session {
  id                 String      @id @default(uuid())
  ticketId           String
  externalTrackingId Int?
  type               SessionType
  startedAt          DateTime
  endedAt            DateTime?
  assignedUserName   String?
  assignedUserEmail  String?
  source             String?
  originImportedTrackingId String?
  processingVersion  String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  ticket           Ticket            @relation(fields: [ticketId], references: [id])
  importedTracking ImportedTracking? @relation(fields: [originImportedTrackingId], references: [id])
  messages         Message[]

  @@unique([ticketId, externalTrackingId])
  @@index([ticketId, startedAt])
  @@map("sessions")
}

model Message {
  id                String    @id @default(uuid())
  ticketId          String
  sessionId         String?
  externalMessageId String
  key               String?
  body              String
  fromMe            Boolean
  senderType        MessageSenderType @default(HUMAN)
  mediaUrl          String?
  mediaType         String?
  createdAtExternal DateTime
  updatedAtExternal DateTime
  rawJson           Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  ticket  Ticket   @relation(fields: [ticketId], references: [id])
  session Session? @relation(fields: [sessionId], references: [id])

  @@unique([ticketId, externalMessageId])
  @@index([ticketId, createdAtExternal])
  @@index([ticketId, sessionId, createdAt])
  @@index([ticketId, sessionId, fromMe, createdAt])
  @@map("messages")
}

enum MessageSenderType {
  HUMAN
  SYSTEM
  AI
}

model ConversationMetrics {
  id                  String   @id @default(uuid())
  clientId            String
  sessionId           String
  firstInboundAt      DateTime @db.Timestamptz
  firstOutboundAt     DateTime @db.Timestamptz
  firstResponseTimeMs Int
  createdAt           DateTime @default(now()) @db.Timestamptz

  client SinapseClient @relation(fields: [clientId], references: [id])

  @@unique([clientId, sessionId])
  @@index([clientId, firstInboundAt])
  @@map("conversation_metrics")
}
